#!/usr/bin/env bash

: <<'END'
dhedit
DigiHub User Configuration Editor

Version 1.0a

Steve de Bode - KQ4ZCI - December 2025

Input:	none
Output: none - interactive
END

# Force bash even if invoked via sh
if [[ -z "${BASH_VERSION-}" ]]; then
  exec /usr/bin/env bash "$0" "$@"
fi

set -euo pipefail

: <<'END'
dhedit
DigiHub User Configuration Editor

Version 1.0a

Steve de Bode - KQ4ZCI - December 2025

Input:  none
Output: none - interactive
END

HomePath="${HOME}"
PROFILE_FILE="${HomePath}/.profile"
DHINFO_FILE="${HomePath}/.dhinfo"

# ---------------- Helpers ----------------

trim() {
  printf '%s' "$1" | sed -e 's/^[[:space:]]\+//' -e 's/[[:space:]]\+$//'
}

backup_file() {
  local f="$1"
  [[ -f "$f" ]] || return 0
  cp -a -- "$f" "${f}.bak.$(date +%Y%m%d-%H%M%S)"
}

SetUnknownIfEmpty() {
  for v in "$@"; do
    [[ -z "$(trim "${!v-}")" ]] && printf -v "$v" '%s' 'Unknown'
  done
}

BuildFullName() {
  fullname=''
  for p in "${forename-}" "${initial-}" "${surname-}" "${suffix-}"; do
    [[ -n "$(trim "$p")" && "$p" != 'Unknown' ]] && fullname="${fullname:+$fullname }$p"
  done
  [[ -z "$fullname" ]] && fullname='Unknown'
}

BuildAddress() {
  address=''
  for p in "${street-}" "${town-}"; do
    [[ -n "$(trim "$p")" && "$p" != 'Unknown' ]] && address="${address:+$address, }$p"
  done

  local sz=''
  [[ "${state-Unknown}" != 'Unknown' ]] && sz="${state}"
  [[ "${zip-Unknown}"   != 'Unknown' ]] && sz="${sz:+$sz }${zip}"
  [[ -n "$sz" ]] && address="${address:+$address, }$sz"

  [[ "${country-Unknown}" != 'Unknown' ]] && address="${address:+$address, }${country}"
  [[ -z "$address" ]] && address='Unknown'
}

profile_get() {
  grep -E "^export $1=" "$PROFILE_FILE" 2>/dev/null | tail -n1 | cut -d= -f2-
}

profile_set() {
  local k="$1" v="$2"
  perl -0777 -pe "s|^export $k=.*$|export $k=$v|m or s|$|\\nexport $k=$v|s" "$PROFILE_FILE" > "$PROFILE_FILE.tmp"
  mv "$PROFILE_FILE.tmp" "$PROFILE_FILE"
}

# ---------------- Load existing ----------------

[[ -f "$PROFILE_FILE" ]] || { printf '%s\n' 'Missing ~/.profile'; exit 1; }

# Pull mutable exports (if present)
callsign="$(profile_get DigiHubcall || true)"
aprspass="$(profile_get DigiHubaprs || true)"
axnodepass="$(profile_get DigiHubaxnode || true)"
gpsport="$(profile_get DigiHubGPSport || true)"
lat="$(profile_get DigiHubLat || true)"
lon="$(profile_get DigiHubLon || true)"
grid="$(profile_get DigiHubgrid || true)"

# Pull .dhinfo (installer order)
if [[ -f "$DHINFO_FILE" ]]; then
  IFS=',' read -r \
    callsign class expiry grid lat lon licstat \
    forename initial surname suffix \
    street town state zip country < "$DHINFO_FILE" 2>/dev/null || true
fi

# IMPORTANT: init all vars so set -u doesn't kill us if .dhinfo is missing/incomplete
: "${callsign:=}"
: "${class:=}"
: "${expiry:=}"
: "${grid:=}"
: "${lat:=}"
: "${lon:=}"
: "${licstat:=}"
: "${forename:=}"
: "${initial:=}"
: "${surname:=}"
: "${suffix:=}"
: "${street:=}"
: "${town:=}"
: "${state:=}"
: "${zip:=}"
: "${country:=}"

SetUnknownIfEmpty callsign class expiry grid lat lon licstat \
                 forename surname street town state zip country
# initial/suffix intentionally allowed to be blank

BuildFullName
BuildAddress

# ---------------- Menu ----------------

ReviewAndEdit() {
  while true; do
    printf '%s\n' '================ REVIEW ================='
    printf '%s\n' '(.dhinfo fields - installer order)'
    printf ' 1) Callsign:   %s\n' "$callsign"
    printf ' 2) Class:      %s\n' "$class"
    printf ' 3) Expiry:     %s\n' "$expiry"
    printf ' 4) Grid:       %s\n' "$grid"
    printf ' 5) Latitude:   %s\n' "$lat"
    printf ' 6) Longitude:  %s\n' "$lon"
    printf ' 7) Lic Status: %s\n' "$licstat"
    printf ' 8) Forename:   %s\n' "$forename"
    printf ' 9) Initial:    %s\n' "$initial"
    printf '10) Surname:    %s\n' "$surname"
    printf '11) Suffix:     %s\n' "$suffix"
    printf '12) Street:     %s\n' "$street"
    printf '13) Town:       %s\n' "$town"
    printf '14) State:      %s\n' "$state"
    printf '15) ZIP:        %s\n' "$zip"
    printf '16) Country:    %s\n' "$country"
    printf '%s\n' '----------------------------------------'
    printf ' Full Name: %s\n' "$fullname"
    printf ' Address:   %s\n' "$address"
    printf '%s\n' '----------------------------------------'
    printf '%s\n' '(Mutable exports in ~/.profile)'
    printf '17) GPS Port:   %s\n' "$gpsport"
    printf '18) APRS Pass:  %s\n' "$aprspass"
    printf '19) AX25 Pass:  %s\n' "$axnodepass"
    printf '%s\n' '========================================'
    read -r -p 'Select 1-19 to edit, Enter to save: ' c
    [[ -z "$c" ]] && break

    case "$c" in
      1) read -r -p 'Callsign (US callsign or non-us): ' v; [[ -n "$v" ]] && callsign="$v" ;;
      2) read -r -p 'License Class: ' v; [[ -n "$v" ]] && class="$v" ;;
      3) read -r -p 'Expiry: ' v; [[ -n "$v" ]] && expiry="$v" ;;
      4) read -r -p 'Grid: ' v; [[ -n "$v" ]] && grid="$v" ;;
      5) read -r -p 'Latitude: ' v; [[ -n "$v" ]] && lat="$v" ;;
      6) read -r -p 'Longitude: ' v; [[ -n "$v" ]] && lon="$v" ;;
      7) read -r -p 'License Status: ' v; [[ -n "$v" ]] && licstat="$v" ;;
      8) read -r -p 'Forename: ' v; [[ -n "$v" ]] && forename="$v" ;;
      9) read -r -p 'Middle Initial (optional): ' v; initial="$v" ;;  # allow blank
      10) read -r -p 'Surname: ' v; [[ -n "$v" ]] && surname="$v" ;;
      11) read -r -p 'Suffix (optional): ' v; suffix="$v" ;;          # allow blank
      12) read -r -p 'Street: ' v; [[ -n "$v" ]] && street="$v" ;;
      13) read -r -p 'Town/City: ' v; [[ -n "$v" ]] && town="$v" ;;
      14) read -r -p 'State: ' v; [[ -n "$v" ]] && state="$v" ;;
      15) read -r -p 'ZIP/Postal: ' v; [[ -n "$v" ]] && zip="$v" ;;
      16) read -r -p 'Country: ' v; [[ -n "$v" ]] && country="$v" ;;
      17) read -r -p 'DigiHubGPSport (nogps or device port): ' v; gpsport="$v" ;;
      18) read -r -p 'DigiHubaprs: ' v; aprspass="$v" ;;
      19) read -r -p 'DigiHubaxnode: ' v; axnodepass="$v" ;;
      *) printf '%s\n' 'Invalid selection.' >&2 ;;
    esac

    # Normalize (NOT initial/suffix)
    SetUnknownIfEmpty callsign class expiry grid lat lon licstat \
                     forename surname street town state zip country \
                     gpsport aprspass axnodepass

    BuildFullName
    BuildAddress
  done
}

ReviewAndEdit

# ---------------- Save ----------------

backup_file "$PROFILE_FILE"
backup_file "$DHINFO_FILE"

profile_set DigiHubcall "$callsign"
profile_set DigiHubaprs "$aprspass"
profile_set DigiHubaxnode "$axnodepass"
profile_set DigiHubGPSport "$gpsport"
profile_set DigiHubLat "$lat"
profile_set DigiHubLon "$lon"
profile_set DigiHubgrid "$grid"

printf '%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s\n' \
  "$callsign" "$class" "$expiry" "$grid" "$lat" "$lon" "$licstat" \
  "$forename" "$initial" "$surname" "$suffix" \
  "$street" "$town" "$state" "$zip" "$country" > "$DHINFO_FILE"

printf '%s\n' 'Configuration updated.'